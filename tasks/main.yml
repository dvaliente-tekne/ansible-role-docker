#SPDX-License-Identifier: MIT-0
---
# tasks file for ansible-role-docker

- name: Create /srv/docker directory
  ansible.builtin.file:
    path: /srv/docker
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Install Docker packages (docker, docker-compose, docker-buildx)
  community.general.pacman:
    name:
      - docker
      - docker-compose
      - docker-buildx
    state: present
  register: docker_packages_install

- name: Confirm Docker packages are installed
  command: pacman -Q docker docker-compose docker-buildx
  register: docker_packages_check
  changed_when: false
  failed_when: docker_packages_check.rc != 0

- name: Enable docker.service (do not start)
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: stopped
  when: docker_packages_check.rc == 0

- name: Start docker.service
  ansible.builtin.systemd:
    name: docker
    state: started
  when: docker_packages_check.rc == 0

- name: Check if dockers network exists
  ansible.builtin.command: docker network inspect dockers
  register: dockers_network_check
  changed_when: false
  failed_when: false
  when: docker_packages_check.rc == 0

- name: Create dockers network
  ansible.builtin.command: docker network create --subnet=192.168.75.0/24 dockers
  when:
    - docker_packages_check.rc == 0
    - dockers_network_check.rc != 0
